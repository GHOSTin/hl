<?xml version="1.0" encoding="UTF-8"?>
<project name="mshc" default="main" basedir=".">
  <property name="BUILD_DIR" value="${project.basedir}/builds/" override="false"/>
  <fileset id="app" dir="${project.basedir}">
    <exclude name="application/application_configuration.php"/>
    <exclude name="build.xml"/>
    <exclude name="tests/**"/>
    <exclude name="cache/**"/>
    <exclude name="composer.lock"/>
    <exclude name="composer.json"/>
  </fileset>
  <fileset id="php_files" dir="${project.basedir}">
    <exclude name="cache/**"/>
    <exclude name="vendor/**"/>
    <include name="**/*.php"/>
  </fileset>
  <!-- targets -->
  <target name="build" depends="clean, tar">
  </target>
  <target name="main"  depends="composer, phplint, tests, clean, tar">
  </target>
  <target name="phplint">
    <phplint haltonfailure="true">
      <fileset refid="php_files" />
    </phplint>
  </target>
  <target name="composer">
    <exec command="composer update" passthru="true" checkreturn="true" />
  </target>
  <target name="tests">
    <exec command="phpunit --bootstrap ./tests/autoload.php --coverage-html builds/cover/ tests/" passthru="true" checkreturn="true" />
  </target>
  <target name="clean">
    <mkdir dir="${BUILD_DIR}" />
    <delete includeemptydirs="true" verbose="true" failonerror="true">
      <fileset dir="${BUILD_DIR}">
          <include name="*.*" />
      </fileset>
    </delete>
  </target>
  <target name="tar">
    <tar destfile="${BUILD_DIR}/${phing.project.name}.tar.gz" compression="gzip">
      <fileset refid="app" />
    </tar>
  </target>
</project>